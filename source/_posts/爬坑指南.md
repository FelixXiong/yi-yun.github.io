---
title: 爬坑指南（一）
date: 2018-07-30 15:24:53
tags:
    - 树莓派
    - 聊天机器人
categories: 树莓派
---
<p align="center">
  <img src="https://i.loli.net/2018/07/22/5b542f5c58d76.jpg" alt="IMG_5686.jpg" title="IMG_5686.jpg" width=250 />
</p>



在大一计算机导论课的时候，老师演示了用 APP 控制 LED 灯的系统，当时觉得很极客。脑海中就幻想，在九点下班的路上，在微信对话框内输入`打开空调`，回到家后就能享受迎面而来的凉风......而这一切都是你自己搭建的，那是多么美妙的事情！

### 相关背景
很早之前，学长送了我一个树莓派作为社团留任礼物。一直想愉快地玩耍，却迟迟不得空。 2018 年寒假终于感受到了嵌入式的魅力。有了寒假折腾的基础（折腾过程可能后续会写到博客），到了嵌入式系统开发的课程，~~为了大作业~~（其实还是自己想折腾）做了一个基于树莓派的微信机器人。
<!--more-->
### 具体实施
跟着脑海中的思路先画了思维导图
![](https://i.loli.net/2018/07/22/5b5469d3cce66.png)

- **模块采用**
查阅资料后，了解到微信机器人 python 模块流行的有两种：itchat 和 wxpy。初步比较后采用 itchat，原因是wxpy是在itchat上改的。从某种意义上来说，itchat 更原始一点。
[itchat 官方文档](http://itchat.readthedocs.io/zh/latest/)
例：
    ```python
    @itchat.msg_register(TEXT)  #处理对话框内的消息先根据消息类型进行注册
    def text_reply(msg):
        return Chat.has_music(msg['Text']
    ```

- **自动回复**
回复对话需要相应的 API 支持，最常见的是图灵机器人（~~个人觉得是名字取得好才常见~~）。本项目用到的还有小豆机器人的 API 。
国外还有被谷歌收购的 api.ai ，基于机器学习，有时间的话可以研究一下。
例：小豆机器人注册账号得到相应的 Key 后可在浏览器打开[链接](http://api.douqq.com/?key=Rzd5bW49Mj0vZ09hbmh0MEJ1VENReGdWd2hZQUFBPT0&msg=什么是物联网)（这里用的是我的 key）
同理图灵机器人也会有相应的 Key，以`res = requests.post(apiUrl, data=data).json()`的代码方式（需要以 json 格式）请求数据，然后得到结果`title = res.get('text')`

- **控制 LED**
对于了解过树莓派 GPIO 的人来说很简单。
    ```python
    import RPi.GPIO as GPIO  #引入模块
    pin=17  #设置引脚
    GPIO.setmode(GPIO.BCM)  #设置BCM模式
    GPIO.setup(pin,GPIO.OUT)  #初始化
    def on():
        GPIO.output(pin,True)   #高电平开
    def off():
        GPIO.output(pin,False)   #低电平关
    ```
- **天气爬取**
室外天气爬取的是墨迹天气，参考的是[树莓派语音闹钟](https://zhuanlan.zhihu.com/p/24983204)
这里用到的[百度 API ](
http://tts.baidu.com/text2audio?idx=1&tex=%E5%9F%BA%E4%BA%8E%E6%A0%91%E8%8E%93%E6%B4%BE%E7%9A%84%E5%BE%AE%E4%BF%A1%E6%9C%BA%E5%99%A8%E4%BA%BA&cuid=baidu_speech_demo&cod=2&lan=zh&ctp=1&pdt=1&spd=5&per=4&vol=5&pit=5)很有意思，关于语音类的以后可能还会用到
因为还有 DHT11 模块获取室内温湿度，所以在原来基础的代码上又加了一些代码
- **点歌播放**
    首先要有音乐播放器`sudo apt-get install mplayer`，这里用到的是 mplayer，后面直接跟链接就能播放
    有了播放器后，接下来是音乐链接了。这里是最苦恼我的地方。几个月前在网上找了很多教程。Linux 相关的最出名的就是网易云音乐了。所以先找的是网易云音乐，什么 Node.js 版，CLI 下的等等，有的功能太全需要登陆，有的不符合要求······总之，均不满意。
    后来无意中浏览小豆机器人功能列表时发现了这货竟然提供点歌播放，迅速输入连接获取的是一串文字，用正则表达式匹配后，竟然成功点歌播放了。只是因为采用的是 HTTP 协议，歌名不能有空格。~~大作业演示的时候不输空格就好了，总比没有好~~
    有了链接后，还需多线程停止播放，不然你得听完整首歌才能开灯，太 Low 了！
    代码如下:
    ```python
    def has_music(text):
    thre=threading.Thread();
    if text[0].__eq__("点") and text[1].__eq__("歌"):
        reply = Tuling.get_response(text)
        pattern=re.compile(r'http://zhangmenshiting.*')
        url=re.findall(pattern,reply)
        url=url[0][0:-1]
        thre=threading.Thread(target=play,args=[url])
        thre.start()
    elif text.__contains__("停止"):
        os.system('killall -9 mplayer' )
    else:
        return deng(text)
    ```
### 项目总结
[项目地址](https://github.com/yi-yun/raspi-chatrobot)
可能因为第一次做项目的关系，略显得有点稚嫩。不仅体现在代码上，还在工作流上有问题。后来静下心来，用思维导图重新梳理了思路，打了草稿，一切都迎刃而解。
欢迎各位看官提出各种见解和建议！
